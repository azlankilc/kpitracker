<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Tracker - Kampung Inggris LC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Styles */
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .nav-item.active {
            background-color: #dc2626;
            color: white;
            border-bottom-color: #dc2626;
        }
        .nav-item {
             border-bottom-color: transparent !important;
        }
        .kpi-card {
            transition: all 0.3s ease;
            border-radius: 0.5rem;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        /* Loading Overlay Style */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
            border-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <svg class="animate-spin w-16 h-16 text-red-600 mb-4" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" class="opacity-25"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl font-medium text-gray-700">Memuat Data dari Google Sheets...</p>
        <p class="text-sm text-gray-500 mt-2">Memerlukan akses data pertama kali (sekitar 15 detik).</p>
    </div>
    
    
    <!-- Header (mainHeader) -->
    <header id="mainHeader" class="bg-white shadow-sm border-b-2 border-red-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">KPI Tracker</h1>
                    <p class="text-sm text-gray-600">Kampung Inggris LC - Monitoring Progress Tim</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 text-gray-400 hover:text-gray-600 relative">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM10.07 2.82l3.12 3.12M7.05 5.84l3.12 3.12M4.03 8.86l3.12 3.12M1.01 11.88l3.12 3.12"></path>
                            </svg>
                            <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                        </button>
                        
                        <!-- Notifications Dropdown -->
                        <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">Notifikasi</h3>
                            </div>
                            <div class="max-h-64 overflow-y-auto">
                                <div class="p-3 border-b border-gray-100 hover:bg-gray-50">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0">
                                            <div class="h-8 w-8 bg-red-100 rounded-full flex items-center justify-center">
                                                <svg class="h-4 w-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <p class="text-sm font-medium text-gray-900">KPI Perlu Perhatian</p>
                                            <p class="text-sm text-gray-500">Cost per Acquisition di bawah target</p>
                                            <p class="text-xs text-gray-400 mt-1">2 jam yang lalu</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 border-t border-gray-200">
                                <button class="text-sm text-red-600 hover:text-red-500 font-medium">Lihat Semua Notifikasi</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <button onclick="toggleProfileMenu()" class="flex items-center space-x-3 text-sm text-gray-600 hover:text-gray-900 focus:outline-none">
                            <div class="h-8 w-8 bg-red-600 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-white" id="userInitials">A</span>
                            </div>
                            <div class="hidden md:block text-left">
                                <div class="font-medium text-gray-900" id="currentUserName">Loading...</div>
                                <div class="text-xs text-gray-500" id="currentUserRole">Administrator (Default)</div>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Profile Dropdown -->
                        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="py-1">
                                <button onclick="showProfile()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Profil Saya
                                </button>
                                <div class="border-t border-gray-100"></div>
                                <button onclick="alert('Tidak dapat Logout, ini adalah mode Dashboard Publik')" class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <button onclick="showPage('dashboard')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors active">
                    Dashboard
                </button>
                <button onclick="showPage('input')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Input KPI
                </button>
                <button onclick="showPage('users')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Input User
                </button>
                <button onclick="showPage('organization')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Struktur Organisasi
                </button>
                <button onclick="showPage('update')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Update Progress
                </button>
                <button onclick="showPage('report')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Report
                </button>
                <button onclick="showPage('access')" class="nav-item px-3 py-4 text-sm font-medium text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-600 transition-colors">
                    Akses & Role
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Filters -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">üîç Filter Dashboard</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Divisi</label>
                        <select id="dashDivisionFilter" onchange="updateDashDepartmentFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="all">Semua Divisi</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Departemen</label>
                        <select id="dashDepartmentFilter" onchange="updateDashFunctionFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="all">Semua Departemen</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fungsi</label>
                        <select id="dashFunctionFilter" onchange="updateDashUserFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="all">Semua Fungsi</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                        <select id="dashUserFilter" onchange="applyDashboardFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="all">Semua User</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button onclick="resetDashboardFilters()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            Reset Filter
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-600">
                        Menampilkan <span id="dashFilteredCount" class="font-medium">0</span> dari <span id="dashTotalCount" class="font-medium">0</span> KPI
                    </div>
                    <div class="text-sm text-gray-600" id="dashFilterInfo">
                        <!-- Filter info will be displayed here -->
                    </div>
                </div>
                
                <!-- Breadcrumb Navigation -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center text-sm text-gray-600">
                        <span class="mr-2">üìç Navigasi:</span>
                        <div id="dashboardBreadcrumb" class="flex items-center space-x-2">
                            <!-- Breadcrumb will be generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Overview -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Performa Keseluruhan</h2>
                    <div class="text-sm text-gray-600" id="breakdownTitle">
                        <!-- Breakdown title will be displayed here -->
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <canvas id="overallChart"></canvas>
                        </div>
                        <p class="text-2xl font-bold text-gray-900" id="overallScore">0%</p>
                        <p class="text-sm text-gray-600">Skor Keseluruhan</p>
                    </div>
                    <div class="space-y-4" id="performanceBreakdown">
                        <!-- Performance breakdown will be generated dynamically -->
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Total KPI:</span>
                            <span class="text-sm font-medium" id="dashTotalKPI">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Tercapai:</span>
                            <span class="text-sm font-medium text-green-600" id="dashAchievedKPI">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Dalam Progress:</span>
                            <span class="text-sm font-medium text-yellow-600" id="dashInProgressKPI">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Perlu Perhatian:</span>
                            <span class="text-sm font-medium text-red-600" id="dashNeedAttentionKPI">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="dashboardKPIContainer">
                <!-- KPI cards will be generated here -->
            </div>
        </main>
    </div>

    <!-- Input Page (Structure only, implementation details in script) -->
    <div id="input" class="page">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Manajemen KPI</h2>
                    <div id="addKPIButtonContainer">
                        <button onclick="openKPIModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            + Tambah KPI Baru
                        </button>
                    </div>
                </div>

                <!-- Existing KPIs -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">KPI Existing</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KPI</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bobot</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode Pengukuran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frekuensi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PIC</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fungsi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kpiTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be generated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Organization Page (Structure only) -->
    <div id="organization" class="page">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Manajemen Struktur Organisasi</h2>
                    <div class="flex space-x-4">
                        <button onclick="openDivisionModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            + Tambah Divisi
                        </button>
                        <button onclick="openDepartmentModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            + Tambah Departemen
                        </button>
                        <button onclick="openFunctionModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            + Tambah Fungsi
                        </button>
                    </div>
                </div>
                
                <!-- Organization Structure Display -->
                <div id="organizationStructureDisplay" class="space-y-6">
                    <!-- Structure will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Users Page (Structure only) -->
    <div id="users" class="page">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Manajemen User</h2>
                    <button onclick="openUserModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        + Tambah User Baru
                    </button>
                </div>
                
                <!-- User Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">üîç Filter & Pencarian User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Pencarian</label>
                            <input type="text" id="userSearchInput" placeholder="Cari nama atau email..." 
                                   onkeyup="filterUsers()" 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Divisi</label>
                            <select id="userFilterDivision" onchange="filterUsers()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="">Semua Divisi</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Departemen</label>
                            <select id="userFilterDepartment" onchange="filterUsers()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="">Semua Departemen</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
                            <select id="userFilterStatus" onchange="filterUsers()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="">Semua Status</option>
                                <option value="active">Aktif</option>
                                <option value="inactive">Tidak Aktif</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end">
                            <button onclick="resetUserFilters()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 text-sm rounded-lg font-medium transition-colors">
                                Reset Filter
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                        <div class="text-xs text-gray-600">
                            Menampilkan <span id="userFilteredCount" class="font-medium">0</span> dari <span id="userTotalCount" class="font-medium">0</span> user
                        </div>
                        <div class="text-xs text-gray-600" id="userFilterInfo">
                            <!-- Filter info will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- User Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total User</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalUserCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">User Aktif</p>
                                <p class="text-2xl font-bold text-gray-900" id="activeUserCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">User Tidak Aktif</p>
                                <p class="text-2xl font-bold text-gray-900" id="inactiveUserCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">User dengan KPI</p>
                                <p class="text-2xl font-bold text-gray-900" id="userWithKPICount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <button onclick="sortUsers('name')" class="flex items-center hover:text-gray-700">
                                        Nama
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </button>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Divisi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departemen</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fungsi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KPI</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- User rows will be generated here -->
                            <tr><td colspan="9" class="text-center py-4 text-gray-500">Memuat data user...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Update Progress Page (Structure only) -->
    <div id="update" class="page">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Update Progress KPI</h2>
                
                <!-- KPI Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih KPI</label>
                    <select id="updateKPISelect" onchange="loadUpdateTable()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="">Pilih KPI untuk update</option>
                    </select>
                </div>
                
                <!-- Update Table Container -->
                <div id="updateTableContainer" class="hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2" id="selectedKPITitle">KPI: -</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Target:</span>
                                <span class="font-medium ml-1" id="selectedKPITarget">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Current:</span>
                                <span class="font-medium ml-1" id="selectedKPICurrent">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Frekuensi:</span>
                                <span class="font-medium ml-1" id="selectedKPIFrequency">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Periode:</span>
                                <span class="font-medium ml-1" id="selectedKPIPeriod">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Update Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="updateTableHeader">
                                    <!-- Dynamic headers will be generated -->
                                </tr>
                            </thead>
                            <tbody id="updateTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic rows will be generated -->
                                <tr><td colspan="4" class="text-center py-4 text-gray-500">Pilih KPI di atas untuk melihat detail update.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveAllUpdates()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-red-600">
                            Simpan Semua Update
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals lainnya... -->
    
    <script>
        // === ‚ö†Ô∏è PENTING: URL WEB APP GOOGLE SHEET ANDA ‚ö†Ô∏è ===
        // URL ini adalah yang terbaru dan harus digunakan
        const SHEET_DB_API_URL = 'https://script.google.com/macros/s/AKfycbzCJgtqnHyc7atUfq6Xa6rmFsZOjbUqRGanSrv8fWJ5ATyIhyKuXxhWRt537-w2tMHB8Q/exec';
        // =======================================================
        
        let initialDataLoaded = false;
        let organizationStructure = {};
        let rolesData = [];
        let userData = [];
        let kpiData = [];
        let kpiUpdateHistory = {}; // Lokal hanya untuk history demo

        let currentPage = 'dashboard';
        let overallChart = null;
        let departmentChart = null;
        
        // --- DEFAULT USER/ROLE (Tanpa Halaman Login) ---
        let currentUser = {
            id: 'admin_default',
            name: "Admin Publik",
            email: "public@dashboard.com",
            division: "Semua",
            department: "Semua",
            function: "Semua",
            role: "Administrator",
            roleLevel: 6,
            permissions: [
                'view_dashboard_filtered', 'view_all_kpi', 'update_own_kpi', 
                'view_division_kpi', 'view_department_kpi', 'view_team_kpi', 
                'create_kpi', 'edit_kpi', 'delete_kpi', 'manage_organization', 
                'manage_users', 'view_all_reports', 'export_reports'
            ],
            joinDate: '2024-01-01',
            lastLogin: new Date().toISOString()
        }; 

        // Filter state (dipertahankan)
        let dashboardFilters = {
            division: 'all', department: 'all', function: 'all', user: 'all'
        };
        let dashboardFilteredKPIData = [];
        let reportFilters = {
            division: 'all', department: 'all', function: 'all'
        };
        let reportFilteredKPIData = [];

        // --- 1. API WRAPPER FUNCTIONS (Menambahkan Timeout) ---
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 15000 } = options; 
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(resource, {
                ...options,
                signal: controller.signal  
            });

            clearTimeout(id);
            return response;
        }

        async function fetchSheetData(sheetName) {
            console.log(`[API] Mengambil data dari sheet: ${sheetName}`);
            const URL = `${SHEET_DB_API_URL}?sheet=${sheetName}`;
            try {
                const response = await fetchWithTimeout(URL, { timeout: 15000 }); 

                if (!response.ok) {
                    throw new Error(`Gagal mengambil data dari ${sheetName}. Status: ${response.status}`);
                }
                const data = await response.json();
                
                // Konversi tipe data numerik
                return data.map(item => ({
                    ...item,
                    id: isNaN(Number(item.id)) ? item.id : item.id,
                    target: Number(item.target) || 0,
                    current: Number(item.current) || 0,
                    weight: Number(item.weight) || 0,
                    level: Number(item.level) || 0,
                    roleId: Number(item.roleId) || null,
                    // Pisahkan permissions (penting setelah perbaikan spasi)
                    permissions: item.permissions ? item.permissions.split(',').map(p => p.trim()).filter(p => p) : []
                }));
            } catch (error) {
                console.error(`[API ERROR] Gagal memuat data sheet ${sheetName}:`, error);
                
                let errorMessage = `Eror saat memuat data dari ${sheetName}. URL API: ${URL}`;
                if (error.name === 'AbortError') {
                    errorMessage = `KONEKSI TIMEOUT (15 detik)! Skrip Google Apps mungkin tidak berjalan.`;
                }

                document.getElementById('loading-overlay').innerHTML = `
                    <div class="p-8 bg-red-100 rounded-xl shadow-2xl border-4 border-red-500 text-center max-w-lg">
                        <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-2xl font-bold text-red-800 mb-2">GAGAL MEMUAT DATA!</h3>
                        <p class="text-red-700 text-sm mb-4">${errorMessage}</p>
                        <p class="text-red-700 text-sm mb-4 font-bold">Tindakan:</p>
                        <ul class="text-left text-red-700 space-y-2 text-sm">
                            <li>1. Cek **Apps Script Log Eksekusi** untuk mencari eror.</li>
                            <li>2. Pastikan izin Web App masih **'Anyone'**.</li>
                            <li>3. Cek format data (permissions tanpa spasi, header roleId).</li>
                        </ul>
                        <button onclick="window.location.reload()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                            Coba Muat Ulang Setelah Diperbaiki
                        </button>
                    </div>
                `;
                document.getElementById('loading-overlay').style.opacity = '1';
                document.getElementById('loading-overlay').style.pointerEvents = 'auto';
                throw new Error(`Failed to load sheet data: ${error.message}`);
            }
        }
        
        async function updateSheetData(sheetName, id, updateFields) {
            console.log(`[API] Mengupdate ID ${id} di sheet: ${sheetName}`);
            
            const payload = { id: id, data: updateFields };

            try {
                const response = await fetchWithTimeout(`${SHEET_DB_API_URL}?sheet=${sheetName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    timeout: 10000 
                });

                if (!response.ok) {
                    throw new Error(`Status HTTP Error: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
                return result;
            } catch(error) {
                console.error(`[API WRITE ERROR] Gagal mengupdate sheet ${sheetName}:`, error);
                alert(`‚ùå Gagal menyimpan ke Google Sheets: ${error.message}`);
                throw new Error(`Gagal menyimpan ke Google Sheets: ${error.message}`);
            }
        }

        // --- 2. INITIAL DATA LOADING & STRUCTURE SETUP ---
        async function loadInitialData() {
            document.body.classList.add('overflow-hidden');
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').style.opacity = '1';

            try {
                const [kpiResult, userResult, roleResult] = await Promise.all([
                    fetchSheetData('KPI'),
                    fetchSheetData('USERS'),
                    fetchSheetData('ROLES')
                ]);

                kpiData = kpiResult;
                rolesData = roleResult;
                userData = userResult.map(user => {
                    const role = rolesData.find(r => r.id === user.roleId);
                    return {
                        ...user,
                        roleName: role ? role.name : 'Individual',
                        roleLevel: role ? role.level : 1,
                        roleColor: role ? ['indigo', 'blue', 'green', 'yellow', 'purple', 'red'][role.id % 6] : 'gray'
                    };
                });
                
                // Set User Interface Default
                const adminUser = userData.find(u => u.roleName === 'Admin' || u.roleName === 'Administrator');
                if (adminUser) {
                    currentUser.name = adminUser.name;
                    currentUser.email = adminUser.email;
                    currentUser.role = adminUser.roleName;
                    currentUser.roleLevel = adminUser.roleLevel;
                    const adminRole = rolesData.find(r => r.id === adminUser.roleId);
                    if (adminRole) {
                        currentUser.permissions = adminRole.permissions;
                    }
                }
                updateUserInterface();

                // Build organization structure dynamically
                organizationStructure = {};
                kpiData.forEach(kpi => {
                    if (!organizationStructure[kpi.division]) organizationStructure[kpi.division] = {};
                    if (!organizationStructure[kpi.division][kpi.department]) {
                        organizationStructure[kpi.division][kpi.department] = { functions: [], members: [] };
                    }
                    if (kpi.function && !organizationStructure[kpi.division][kpi.department].functions.includes(kpi.function)) {
                        organizationStructure[kpi.division][kpi.department].functions.push(kpi.function);
                    }
                });
                userData.forEach(user => {
                    if (organizationStructure[user.division] && organizationStructure[user.division][user.department]) {
                        if (!organizationStructure[user.division][user.department].members.includes(user.name)) {
                            organizationStructure[user.division][user.department].members.push(user.name);
                        }
                    }
                });
                
                rolesData.forEach(role => {
                    role.userCount = userData.filter(u => u.roleId === role.id).length;
                });
                
                initializeKPIHistory();
                initialDataLoaded = true;
                
                // HIDE LOADING OVERLAY dan masuk ke dashboard
                document.getElementById('loading-overlay').style.display = 'none';
                document.body.classList.remove('overflow-hidden');
                
                showPage('dashboard'); 
                
            } catch (error) {
                console.log("Initialization failed. Check API error details above.");
            }
        }
        
        // --- 3. CORE APPLICATION FUNCTIONS ---

        function hasPermission(permission) {
            if (!currentUser) return false;
            if (currentUser.roleLevel >= 6) return true; 
            return currentUser.permissions && currentUser.permissions.includes(permission);
        }

        function canAccessPage(page) {
             if (!currentUser) return false;
            
            switch(page) {
                case 'dashboard': return hasPermission('view_dashboard_filtered');
                case 'input': return hasPermission('create_kpi') || hasPermission('view_own_kpi');
                case 'users': return hasPermission('manage_users');
                case 'organization': return hasPermission('manage_organization');
                case 'update': return hasPermission('update_own_kpi');
                case 'report': return hasPermission('view_all_reports');
                case 'access': return hasPermission('manage_roles');
                case 'profile': return true;
                default: return false;
            }
        }
        
        function showPage(page) {
            if (!canAccessPage(page)) { alert('Anda tidak memiliki akses ke halaman ini!'); return; }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            const navButton = document.querySelector(`.nav-item[onclick*="showPage('${page}')"]`);
            if (navButton) { navButton.classList.add('active'); }
            currentPage = page;
            if (page === 'dashboard') { loadDashboard(); } else if (page === 'input') { loadInputPage(); } // ... dll.
        }

        async function updateKPIProgress(kpiId, newProgress, notes, updateDate, updatedBy, source = 'manual') {
            const kpiIndex = kpiData.findIndex(k => k.id === kpiId);
            if (kpiIndex === -1) {
                throw new Error('KPI tidak ditemukan');
            }
            
            const kpi = kpiData[kpiIndex];
            const oldProgress = kpi.current;
            
            if (isNaN(newProgress) || newProgress < 0) {
                throw new Error('Progress harus berupa angka positif');
            }
            
            const updateFields = { current: newProgress };
            
            await updateSheetData('KPI', kpi.id, updateFields);
            
            // Update local data
            kpiData[kpiIndex].current = newProgress;
            
            // Add to history
            const historyEntry = addKPIUpdateHistory(
                kpiId, oldProgress, newProgress, notes, updateDate, updatedBy
            );
            
            refreshAllPages();
            
            return {
                kpi: kpiData[kpiIndex],
                historyEntry: historyEntry,
                source: source
            };
        }

        // --- DUMMY/MINIMAL IMPLEMENTATION FOR CORE FUNCTIONS ---
        function loadDashboard() { initializeDashboardFilters(); applyDashboardFilters(); }
        function initializeDashboardFilters() {
            const divisions = new Set(kpiData.map(k => k.division));
            const divisionFilter = document.getElementById('dashDivisionFilter');
            divisionFilter.innerHTML = '<option value="all">Semua Divisi</option>' + Array.from(divisions).map(d => `<option value="${d}">${d}</option>`).join('');
            // Lanjutkan inisialisasi filter lainnya...
        }
        function applyDashboardFilters() {
             dashboardFilteredKPIData = kpiData.filter(kpi => kpi.division.includes(dashboardFilters.division) || dashboardFilters.division === 'all');
            document.getElementById('dashFilteredCount').textContent = dashboardFilteredKPIData.length;
            document.getElementById('dashTotalCount').textContent = kpiData.length;
            updateDashboardSummary();
        }
        function updateDashboardSummary() { /* ... */ }
        function updateUserInterface() {
             document.getElementById('currentUserName').textContent = currentUser.name;
             document.getElementById('currentUserRole').textContent = currentUser.role;
             document.getElementById('userInitials').textContent = currentUser.name.charAt(0).toUpperCase();
        }
        function initializeNavigation() { /* ... */ }
        function updateDashboardBreadcrumb() { /* ... */ }
        function resetDashboardFilters() { /* ... */ }
        function updateDashDepartmentFilter() { applyDashboardFilters(); }
        function updateDashFunctionFilter() { applyDashboardFilters(); }
        function updateDashUserFilter() { applyDashboardFilters(); }
        function updateOverallChart() { /* ... */ }
        function renderDashboardKPIs() { /* ... */ }
        function loadInputPage() { /* ... */ }
        function refreshAllPages() { 
            if (currentPage === 'dashboard') { applyDashboardFilters(); } 
            if (currentPage === 'input') { loadInputPage(); }
        }
        function initializeKPIHistory() { /* ... */ }
        function addKPIUpdateHistory(kpiId, oldProgress, newProgress, notes, updateDate, updatedBy) { /* ... */ }
        function getKPIStatus(current, target) { /* ... */ return 'achieved'; }
        function formatNumber(num) { /* ... */ return num.toString(); }

        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
        });
    </script>
</body>
</html>
